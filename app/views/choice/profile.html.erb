<!-- ko stopBinding: true -->

	<div id="profile" data-bind="with: current_user " class="ballot-section">
			<!-- Primary Color -->
			<style type="text/css" data-bind="text: primary() != null ? 
			'h1.sectionheading { color:'+primary()+' !important;}'
			: ''
			">h1.sectionheading { color: <%= @user.primary %>!important;}
			</style>
			<!-- Secondary Color -->
			<style type="text/css" data-bind="text: primary() != null ? 
			'h1.title::before, .optionholder.your-option .option:first-child { color:'+secondary()+' !important;}'+
			'.ballot-section .sectionheading, .ballot-section .category-heading, .account { border-color: '+secondary()+'!important; }'
			: ''
			">h1.title::before, .optionholder.your-option .option:first-child { color: <%= @user.secondary %> !important;}
			.ballot-section .sectionheading, .ballot-section .category-heading, .account { border-color: <%= @user.secondary %> !important; }
			</style>
			<!-- BG Color -->
			<style type="text/css" data-bind="text: primary() != null ? 
			'body { background:'+bg()+' !important; background-image: none; }'
			: ''
			">body { background:  <%= @user.bg %> !important; background-image: none; }
			</style>
		
			<%- if current_user == @user %>
			<%= javascript_include_tag 'jquery.remotipart' %>
			<div id="edit-profile">
				<a data-bind="visible: !edit() " class="link"><span data-bind="click: function() {open() }"><i class="icon-cog"></i> Edit Your Voter Guide </span></a> | 
				<div style="display: none" class="editor" data-bind="visible: edit ">
					<input data-bind="value: guide_name, valueUpdate: 'afterkeydown'" placeholder="Name Your Voter Guide">


					<textarea data-bind="value: description, valueUpdate: 'afterkeydown'" placeholder="Write something about your voter guide"></textarea>

					http://theballot.org/<input class="edit-profile" style="display: inline" data-bind="value: profile, valueUpdate: 'afterkeydown'" placeholder="Set your guide's URL"  >
					<span data-bind="visible: profile.checking() ">Searching...</span><span data-bind="visible: profile.available() ">Available</span><span data-bind="visible: !profile.available() && profile.available() != null ">Taken :(</span>
					<br />Current Url: <a data-bind="text: '<%= ENV['BASE'] %>/'+profile.store(), attr: { href: '<%= ENV['BASE'] %>/'+profile.store()} "></a>

					<input data-bind="value: primary, style: { color: primary() }, valueUpdate: 'afterkeydown'" placeholder="Change the title text's color"  >
					<input data-bind="value: secondary, style: {color: secondary() }, valueUpdate: 'afterkeydown'" placeholder="Change the secondary color"  >
					<input data-bind="value: bg, style: {color: bg() }, valueUpdate: 'afterkeydown'" placeholder="Change the the background color"  >

					<p><span class="link" data-bind="click: function() { save() } ">Save</span> | <span class="link" data-bind="click: function() { discard() }">Cancel</span></p>

					<%= form_for @user, :url => user_update_path, :method => :POST, :html => { :multipart => true }, :remote => true, :format => :json do |form| %>
						<%= form.file_field :header %>
						Must at least 860 x 180. Will overwrite your current header
						<%= form.submit 'Upload' %>
						<span class="link" data-bind="click: function() { removeHeader() }, visible:  typeof header() != 'undefined' && header() != null && header() != '/headers/header/missing.png'">Remove Header</span>
					<% end %>
					

				</div>
				<div class="status">
					<p><strong><%= 'Your account has been deactivated - all of your comments and votes are hidden'  if current_user.deactivated? %></strong></p>
					<p><strong><%= 'Your account has been banned - all of your comments and votes are hidden'  if current_user.banned? %></strong></p>
					<a><%= link_to 'Reactivated it now', user_cancel_path  if current_user.deactivated? %></a>
					<i class="icon-trash"></i><a><%= link_to ' Deactivate Your Account', user_cancel_path, :class =>'cancel'  if !current_user.deactivated? %></a>
				</div>
			</div>

	
			

			<script type="text/javascript">
				current_user.guide_name = ko.observable(current_user.guide_name )
				current_user.description = ko.observable(current_user.description)

				current_user.profile = ko.observable(current_user.profile.replace('/','') != current_user.url.replace('/','') ? current_user.profile.replace('/','') : '')
				current_user.profile.store = ko.observable( current_user.url.replace('/','') )
				current_user.profile.available = ko.observable(null)
				current_user.profile.checking = ko.observable(false)
				current_user.profile.checkAvailable = ko.computed( function() {
					var profile = current_user.profile()
					if( profile.replace('/','').replace(/ /g,'+').toLowerCase() != profile ) current_user.profile( profile.replace(/ /g,'+').replace('/','').toLowerCase() )
					if( profile != '' && profile != this.profile.store() && this.profile.store() != this.url.replace('/','') ) {
						profile = profile.replace('/','')
						current_user.profile.checking(true)
						$.get('<%= search_path %>',{term: profile, filter: 'profile'},function(r) {
							current_user.profile.checking(false)
							if( r.length > 0 ) current_user.profile.available(false)
							else current_user.profile.available(true)
						})
					}
				},current_user).extend({ throttle: 800 })


				current_user.header = ko.observable( '<%= @user.header.url(:header) %>')

				current_user.primary = ko.observable( '<%= @user.primary %>')
				current_user.secondary = ko.observable( '<%= @user.secondary %>')
				current_user.bg = ko.observable( '<%= @user.bg %>')
				
				current_user.edit = ko.observable(false)
				current_user.open = function() { 
					current_user.edit(true);
					current_user.__guide_name = current_user.guide_name();
					current_user.__description = current_user.description();
					if( current_user.profile() != '' ) current_user.profile.store(  current_user.profile() );
					current_user.__primary = current_user.primary()
					current_user.__secondary = current_user.secondary()
					current_user.__bg = current_user.bg()
				}
				current_user.removeHeader = function() {
					current_user.header('http://localhost:3000/assets/theballot.png' )
					$.post('users/update',inits.root+'users/update',{ user: {header: null} } )
				}
				current_user.discard = function() {
					current_user.edit(false);
					current_user.guide_name( current_user.__guide_name );
					current_user.__guide_name = null;
					current_user.description( current_user.__description );
					current_user.__description = null;
					current_user.profile( current_user.profile.store() );
					current_user.primary( current_user.__primary );
					current_user.__primary = null;
					current_user.secondary( current_user.__secondary );
					current_user.__description = null;
					current_user.bg( current_user.__bg );
					current_user.__bg = null;
				}
				current_user.save = function() { 
					if( !current_user.profile.available() ) {
						return false
						$('input.profile').focus()
					}
					current_user.profile.store( current_user.profile() );
					current_user.profile.available(null);
					
					current_user.edit(false);
					current_user.__guide_name = null;
					current_user.__description = null;
					current_user.__bg = null;
					current_user.__primary = null;
					current_user.__secondary = null;
					$.post( inits.root+'users/update', { guide_name:  current_user.guide_name(), primary:  current_user.primary(), secondary:  current_user.secondary(), bg:  current_user.bg(), profile:  current_user.profile() }, function(r) { 
						if( r.success && '/'+current_user.profile() != document.location.pathname ) {
							var stateObj = {};
							history.pushState(stateObj, "new Profile", '/'+current_user.profile());
						}
					})
				}
				current_user.__headerFix = ko.computed( function() {
					var header = this.header()
					if( typeof header != 'undefined' && header != null && header != '/headers/header/missing.png' ) $('#logo img').attr('src',header)
				}, current_user)
				current_user.__titleFix = ko.computed( function() {
					var title = this.guide_name()
					if( title != null && title.trim().length > 0 )document.title = 'The Ballot | '+title
				},current_user)

				$(document).ready( function() { 
					ko.applyBindings( current_user, document.getElementById("profile")); 
					$('#logo img').error( function() { $(this).attr('src','<%=asset_path( 'theballot.png' )%>') });
				}).ajaxComplete(function(event, XMLHttpRequest, ajaxOptions) {
					// Only when it's remotipart. There's probably a better way to do this but I can't figure it out now
					if( typeof ajaxOptions.data != 'undefined' && typeof ajaxOptions.data[2] != 'undefined' && ajaxOptions.data[2].name == "remotipart_submitted" && XMLHttpRequest.readyState == 4) { 
						var data = JSON.parse(XMLHttpRequest.responseText)
						if( data.success ) current_user.header( data.header )
					}
				})
			</script>

		<% else %>
			<%- unless current_user.nil? %>
				<span class="link flag" onclick="$(this).hide().next().show()"><i class="icon-flag"></i> Flag this User</span>
				<p style="display: none;" class="flag">Are you sure? <span class="link" onclick=" 
					$(this).parent().text('Flagged - thanks');
					yourLocation.choices().map( function(el) { $.post(inits.root+'feedback/'+el.featured().id+'/flag',function(response){}) } )
				">Yes</span> </p>
			<% end -%>
		<% end -%>

		<h1 class="sectionheading" data-bind="text: guide_name() != null && guide_name() != '' ? guide_name : [name+'\'s','Voter Guide'].join(' ') "><%= @user.guide_name || @user.name + '\'s Voter Guide' %></h1>
		<div class="category-heading">
			<p class="description" data-bind=" text: description"><%= @user.description %></p>
		</div>
		
	</div>

<!-- /ko -->

<% n = 0 %>

<div id="personal-guide">
<div id="read-ballot">
	<% @choices.each do |choice| %>
		<div data-bind="with: choices()[<%= n %>]" class="row">
			<% type = choice.contest_type.downcase.index('ballot').nil? ? 'candidateProfile' : 'measureProfile' %>
			<%=  render 'choice/'+type, :choice => choice, :user => @user %>
		</div>
	<% n+=1%>
	<% end %>
	<% if @choices.length == 0 && @user != current_user %>
		<p></p>
		<p><%= @user.first_name %> hasn't left any sort of feedback.</p>
		<p><em>Redirecting you to the home page in 2.012 seconds</em></p>
		<script type="text/javascript"> ( function() { setTimeout( function() { document.location = '<%= root_path %>'; }, 2012);} )()</script>
	<% end %>
</div>
</div>