<% choice = choice || Choice.new %>
<% user = user || nil %>
<% choice.options.new if choice.new_record?  %>

<a data-bind="attr:{name:$data.contest}"></a>

<div class="measure row <%= 'selected' unless choice.new_record? %> commentable" 
	data-bind="css: { selected: $root.selected() == $data, complete: $data.you() }"
	itemscope itemtype="http://data-vocabulary.org/Thing" >

	<hr><h1 itemprop="name" class="title" data-bind="text: $data.contest"><%= choice.contest %></h1><hr>
	<div itemprop="description" class="explanation" data-bind="text: $data.description, elastic: true"><%= choice.description %></div>
	<div itemprop="" class="voted" data-bind="html: '<i class=icon-comments-alt></i> ' +$data.voted()+' '+( $data.voted() == 1 ? 'person' : 'people' )+' have voted | ' +$data.commentsPure()+' '+( $data.commentsPure() == 1 ? 'person' : 'people' )+' have commented' "></div>
	<button class="open">Learn More and Comment</button>
	<hr class="button">

	<div class="body">
		<div class="full-text">
			<a target="_blank" href="<%= choice.options.first.blurb_source %>" data-bind="visible: $data == $root.selected(), href: $data.options()[0].blurb_source" >View full text  <i class="icon-external-link"></i></a>
		</div>

		<% n = 0 %>
		<% choice.options.each do |option| %>
		<div class="optionholder <%= 'clean-no-script' if n != 0 %>" >
			<!-- ko foreach: $data.options -->
				<div class="option">
					<h1 data-bind="text: $data.name, stripClass: true, addClass: $data.type" class="<%= option.option_type unless option.new_record? %> ">
						<%= option.name %>
					</h1>
					<img data-bind="src: $data.photo" src="<%= option.photo %>">
					<div class="blurb" data-bind="text: $data.blurb "><%= option.blurb %></div>

					<div class="faces">
						<div class="minicounter" data-bind="">
							<div data-bind="html: $data.support()+' '+( $data.support() == 1 ? 'person' : 'people' )+' '+($data.type == 'yes' ? 'support' : 'oppose')+( $data.support() == 1 ? 's' : '' )+'<br />'+$parent.contest"></div>
						</div>
						<!-- ko foreach: $data.faces.show -->
							<a target="_blank" data-bind="attr: {href: $data.url }">
								<img class="face miniimage" data-bind="src: $data.image, attr: { alt: $data.name }">
							</a>
						<!-- /ko -->
					</div>
				</div>
			<!-- /ko -->
		</div>
		<% n+=1 %>
		<% end %>

			<%- if current_user != user || !current_user.nil? %>
				<%= render 'choice/measureFeedback', :user => user, :feedback => choice.options.map{ |o| o.new_record? ?  o.feedback : o.feedbacks }.flatten.first %>
			<%- end %>

			<%- if user.nil? %>
				<% # hiding all of this if a featured user is set - i.e. we're looking at a profile  %>
				<div class="commentTitle" data-bind="visible: feedback.realLength() > 0  ">
					What Others Are Saying
					<select data-bind="value: $data.mode">
						<option value="normal">Sort By...</option>
						<option value="best">Most Helpful</option>
						<option value="friends">Your Friends</option>
						<option value="yes" >In Support</option>
						<option value="no" >In Opposition</option>
					</select>
					<div class="arrows">&#x25B2;<br />&#x25BC;</div>
				</div>
			
			
				<ul data-bind="foreach: feedback.everyone" class="feedback">
					<li data-bind="addClass: $data.type ">

						<div class="head" data-bind="addClass: $data.type ">
							<a data-bind="attr: {href: $data.url }" >
								<img class="face" data-bind="src: $data.image, attr: { alt: $data.name }" >
							</a>
						</div>

						<strong data-bind="text: $data.option_name+' on '+$parent.contest+':'"></strong>
						<div class="message" data-bind="text: $data.comment"></div>

						<div class="foot">
								<a data-bind="text: $data.name, attr: {href: $data.url }"></a>&nbsp;|&nbsp;<span data-bind="text: $data.time"></span>
							<br />
								<%- if !current_user.nil? %>
									<div class="ask">
										Was this helpful?
										<span class="helpful link" >Yes</span>
											&nbsp;|&nbsp;
										<span class="not link">No</span>
											&nbsp;|&nbsp;
										<span class="flag link">Flag</span>
									</div>
								<% end -%>
						</div>

					</li>
				</ul>
				<%- if current_user.nil? %>
					<%= render 'choice/measureFeedback', :feedback => current_user.nil? ? nil : choice.options.map{ |o| o.new_record? ?  o.feedback : o.feedbacks }.flatten.select{ |f| f.user_id == current_user.id }.first %>
				<% end -%>
			<% end -%>

			<div class="footer" >
				<meta itemprop="url" content="<%= choice.to_url%>" />
				<a href="<%= choice.to_url %>" class="full" data-bind="visible: !$data.all() && $data.comments > 3, attr: { href: '/'+$data.geography+'/'+$data.contest.replace(/ /g,'_') }">Read All Comments</a>
				<a href="#" class="full get-more" data-bind="visible: $data.all() && $data.feedback.more() ">Load More Comments</a>
			</div>

			<hr class="button lower">



	</div>
</div>