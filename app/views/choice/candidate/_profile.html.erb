<% choice = choice || Choice.new %>
<% user = user || nil %>
<% choice.options.new if choice.new_record?  %>
<% feedback = user.nil? ? nil : choice.options.map{ |o| o.new_record? ?  o.feedback : o.feedbacks }.flatten.select{ |f| f.user_id == user.id }.first %>
<% userObj = user == current_user ? 'you()' : 'featured()'  %>



<a name="<%= choice.contest %> <%= choice.geography %>"></a>

<div class="candidate row <%= 'selected' unless choice.new_record? %> <%= 'commentable ' if choice.commentable? %>" 
	data-bind="css: { selected: $root.selected() == $data }"
	itemscope itemtype="http://data-vocabulary.org/Thing" >

	<hr><a href="<%= choice.to_url %>" class="full" data-bind="attr: { href: '/'+$data.geography+'/'+$data.contest.replace(/ /g,'_') }"><h1 itemprop="name" class="title" data-bind="text: $data.contest"><%= choice.contest %></h1></a><hr>
	<div class="profile-explanation">
	<h2 class="profile-text">The Candidates</h2>
	<div class="optionholder your-option" >
		<!-- ko foreach: $data.options -->
			<span class="option" data-bind="html: $data.name+' '+$data.partySmall()+'<br />'"><%=  feedback.option.name %> <%=  feedback.option.partySmall %></span>
		<!-- /ko -->
	</div>
	<% n = 0 %>
	<% choice.options.reject{|o| o == feedback.option }.each do |option| %>
		<div class="optionholder clean-no-script" >
				<span class="option" data-bind="html: $data.name+' '+$data.partySmall()+'<br />'"><%= option.name %> <%= option.partySmall %></span>
		</div>
	<% end %>
	</div>

	<div class="profile-comment">
		<h2 class="profile-text" style="<%= 'display:none;' unless !feedback.nil? && !feedback.comment.nil? && feedback.comment.length > 0 %>" data-bind=" visible: $data.<%= userObj %>.comment != null && $data.<%= userObj %>.comment.length > 0">What I Say</h2>

		<p style="<%= 'display: none' unless !feedback.nil? & !feedback.comment.nil? && feedback.comment.length > 0 %>" data-bind="text: $data.<%= userObj %>.comment, visible: $data.<%= userObj %>.comment != null && $data.<%= userObj %>.comment.length > 0, addClass: $data.<%= userObj %>.type" >
			<%- if !feedback.nil? && !feedback.comment.nil? && feedback.comment.length > 0 %>
				<%= '"'+feedback.comment+'"' %>
			<% end -%>
		</p>
		<div class="head" data-bind="addClass: $data.<%= userObj %>.type, visible: $data.<%= userObj %>.comment != null && $data.<%= userObj %>.comment.length > 1 ">
			<img data-bind="src: <%= userObj %>.image" src="<%= user.image unless user.nil? %>">
		</div>
	</div>

	<!-- These should work... might need to be massaged a bit. Hopefully they both could work asynchronously -->
	<%- if user == current_user %>
		<div class="controls">
			<span class="link meme"><i class="icon-picture"></i> Create Badge</span> | <span class="remove link" >Remove</span> | 
			<!-- Here's a link to the single page - just move this around -->
			<a href="<%= choice.to_url %>" class="full" data-bind="attr: { href: '/'+$data.geography+'/'+$data.contest.replace(/ /g,'_') }">Edit</a>
		</div>
	<% end -%>
		


</div>